generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  SUPER_ADMIN
  ADMIN
  BARBER
  CLIENT
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
}

enum PaymentMethod {
  ONLINE
  CASH
  CARD
  SUBSCRIPTION
}

enum CommissionType {
  SERVICE
  PRODUCT
  SUBSCRIPTION
  EXTRA
}

enum CommissionStatus {
  PENDING
  PAID
}

enum OrderStatus {
  OPEN
  CLOSED
  PAID
  CANCELLED
}

// Models

model User {
  id        String   @id @default(uuid())
  name      String
  email     String?  @unique
  password  String?
  phone     String?  @unique
  birthday  DateTime?
  role      Role     @default(CLIENT)
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownedBarbershops Barbershop[] @relation("BarbershopOwner")
  
  // If user is staff (Barber/Admin)
  workedBarbershopId String?
  workedBarbershop   Barbershop? @relation("BarbershopStaff", fields: [workedBarbershopId], references: [id])

  // If user is a professional (has specific profile)
  professionalProfile Professional?

  // As a client
  clientAppointments Appointment[] @relation("ClientAppointments")
  
  // As a professional (service provider)
  proAppointments    Appointment[] @relation("ProAppointments")
  subscriptions      UserSubscription[]
  commissions        Commission[]
  
  // Orders
  clientOrders       Order[] @relation("ClientOrders")
  professionalOrders Order[] @relation("ProfessionalOrders")
}

model Barbershop {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  address   String?
  phone     String?
  logoUrl   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ownerId   String
  owner     User     @relation("BarbershopOwner", fields: [ownerId], references: [id])

  staff     User[]   @relation("BarbershopStaff")
  services  Service[]
  products  Product[]
  appointments Appointment[]
  transactions Transaction[]
  waitlist     Waitlist[]
  subscriptionPlans SubscriptionPlan[]
  commissions  Commission[]
  orders       Order[]
}

model Professional {
  id        String @id @default(uuid())
  userId    String @unique
  user      User   @relation(fields: [userId], references: [id])
  bio       String?
  position  String? // Cargo (Ex: Barbeiro SÃªnior, Auxiliar)
  
  schedules Schedule[]
}

model Service {
  id           String @id @default(uuid())
  name         String
  description  String?
  price        Decimal  @db.Decimal(10, 2)
  duration     Int      // Minutes
  active       Boolean  @default(true)
  
  barbershopId String
  barbershop   Barbershop @relation(fields: [barbershopId], references: [id])

  appointments Appointment[]
  waitlist     Waitlist[]
}

model Schedule {
  id             String @id @default(uuid())
  dayOfWeek      Int    // 0=Sunday, 1=Monday...
  startTime      String // "09:00"
  endTime        String // "18:00"
  isOff          Boolean @default(false)
  professionalId String
  professional   Professional @relation(fields: [professionalId], references: [id])
}

model Appointment {
  id        String   @id @default(uuid())
  date      DateTime
  status    AppointmentStatus @default(PENDING)
  notes     String?
  
  clientId  String
  client    User     @relation("ClientAppointments", fields: [clientId], references: [id])

  professionalId String
  professional   User     @relation("ProAppointments", fields: [professionalId], references: [id])

  serviceId String
  service   Service  @relation(fields: [serviceId], references: [id])

  barbershopId String
  barbershop   Barbershop @relation(fields: [barbershopId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  paymentStatus PaymentStatus @default(PENDING)
  paymentMethod PaymentMethod?

  transactions Transaction[]
  commissions  Commission[]
}

model Product {
  id          String   @id @default(uuid())
  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  costPrice   Decimal? @db.Decimal(10, 2)
  stock       Int      @default(0)
  
  barbershopId String
  barbershop   Barbershop @relation(fields: [barbershopId], references: [id])
  
  orderItems   OrderItem[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum TransactionType {
  INCOME
  EXPENSE
}

model Transaction {
  id           String   @id @default(uuid())
  description  String
  amount       Decimal  @db.Decimal(10, 2)
  type         TransactionType
  category     String?  // Ex: Aluguel, Produto, Marketing
  date         DateTime @default(now())
  
  barbershopId String
  barbershop   Barbershop @relation(fields: [barbershopId], references: [id])

  appointmentId String?
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
model Waitlist {
  id           String   @id @default(uuid())
  date         DateTime
  clientName   String
  clientPhone  String
  
  barbershopId String
  barbershop   Barbershop @relation(fields: [barbershopId], references: [id])
  
  serviceId    String
  service      Service    @relation(fields: [serviceId], references: [id])

  createdAt    DateTime @default(now())
}

model SubscriptionPlan {
  id            String   @id @default(uuid())
  name          String
  price         Float
  quantityOfCuts Int
  validityDays  Int
  
  barbershopId  String
  barbershop    Barbershop @relation(fields: [barbershopId], references: [id])
  
  subscriptions UserSubscription[]
  createdAt     DateTime @default(now())
}

model UserSubscription {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  planId          String
  plan            SubscriptionPlan @relation(fields: [planId], references: [id])
  
  startDate       DateTime @default(now())
  endDate         DateTime
  remainingCuts   Int
  status          String   @default("ACTIVE") // ACTIVE, EXPIRED, CANCELLED
  
  createdAt       DateTime @default(now())
}

model Commission {
  id              String   @id @default(uuid())
  
  barberId        String
  barber          User     @relation(fields: [barberId], references: [id])
  
  barbershopId    String
  barbershop      Barbershop @relation(fields: [barbershopId], references: [id])
  
  appointmentId   String?
  appointment     Appointment? @relation(fields: [appointmentId], references: [id])
  
  type            CommissionType
  description     String?
  amount          Float
  percentage      Float?
  status          CommissionStatus @default(PENDING)
  
  paidAt          DateTime?
  createdAt       DateTime @default(now())
}

model Order {
  id              String   @id @default(uuid())
  
  appointmentId   String   @unique
  appointment     Appointment @relation(fields: [appointmentId], references: [id])
  
  barbershopId    String
  barbershop      Barbershop @relation(fields: [barbershopId], references: [id])
  
  clientId        String
  client          User     @relation("ClientOrders", fields: [clientId], references: [id])
  
  professionalId  String
  professional    User     @relation("ProfessionalOrders", fields: [professionalId], references: [id])
  
  status          OrderStatus @default(OPEN)
  
  subtotal        Float    @default(0)
  discount        Float    @default(0)
  total           Float    @default(0)
  
  paymentMethod   PaymentMethod?
  paymentStatus   PaymentStatus @default(PENDING)
  paidAt          DateTime?
  
  notes           String?
  
  items           OrderItem[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model OrderItem {
  id          String   @id @default(uuid())
  
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  type        String   // "SERVICE" or "PRODUCT"
  
  serviceId   String?
  service     Service? @relation(fields: [serviceId], references: [id])
  
  productId   String?
  product     Product? @relation(fields: [productId], references: [id])
  
  quantity    Int      @default(1)
  unitPrice   Float
  total       Float
  
  createdAt   DateTime @default(now())
}
